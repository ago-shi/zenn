---
title: "è¨¼æ˜æ›¸ã‚’ä½¿ã£ã¦sshæ¥ç¶šã™ã‚‹ with Hashicorp Vault"
emoji: "ğŸ‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["hashicorpVault", "openSSH"]
published: true
---
## ã“ã®è¨˜äº‹ã®ç›®çš„
- openSSHã§ã®sshè¨¼æ˜æ›¸ã«ã‚ˆã‚‹èªè¨¼ã®å®Ÿç¾æ–¹æ³•ãŒåˆ†ã‹ã‚‹ã€‚
- hasicorp vaultã§ã®sshç”¨CAã®å®Ÿç¾æ–¹æ³•ãŒåˆ†ã‹ã‚‹ã€‚

## å‰æçŸ¥è­˜
![](/images/ssh/sshca/sshCAConcept.png =500x)
*è¨¼æ˜æ›¸èªè¨¼ã®æ¦‚å¿µå›³*

### ssh CA 
SSHç”¨è¨¼æ˜æ›¸ã‚’ç™ºè¡Œã™ã‚‹ã€‚
ä»Šå›ã¯Hashicorp Vault ssh engineã‚’åˆ©ç”¨ã™ã‚‹ã€‚

### SSHã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
SSHã‚µãƒ¼ãƒã‚’èªè¨¼ã™ã‚‹ã€‚(SSHã‚µãƒ¼ãƒè¨¼æ˜æ›¸ã®æœ‰åŠ¹æ€§ã‚’æ¤œè¨¼ã™ã‚‹ã€‚)

### SSHã‚µãƒ¼ãƒ
SSHã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’èªè¨¼ã™ã‚‹ã€‚(SSHã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨¼æ˜æ›¸ã®æœ‰åŠ¹æ€§ã‚’æ¤œè¨¼ã™ã‚‹ã€‚)

:::message
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆã¯ã‚µãƒ¼ãƒã®èªè¨¼ã®ã©ã¡ã‚‰ã‹ä¸€æ–¹ã ã‘ã«è¨¼æ˜æ›¸ã‚’ä½¿ã†ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚
ã©ã¡ã‚‰ã‹ã‚’è¨¼æ˜æ›¸èªè¨¼ã«ã—ãŸã„ã®ã«ã€ä¸¡æ–¹ã¨ã‚‚è¨¼æ˜æ›¸èªè¨¼ãŒå¿…é ˆã«ãªã‚‹ã¨ã†ã“ã¨ã¯ãªã„ã€‚
:::

## å‰æç’°å¢ƒ
### ssh CA 
hashicorp Vault v1.16.2
OS->AlmaLinux release 9.1 (Lime Lynx)

### SSHã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
OpenSSH_8.7p1, OpenSSL 3.2.2 4 Jun 2024
OS->AlmaLinux release 9.5 (Teal Serval)

### SSHã‚µãƒ¼ãƒ
OpenSSH_8.7p1, OpenSSL 3.2.2 4 Jun 2024
OS->AlmaLinux release 9.5 (Teal Serval)

## SSHã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®è¨¼æ˜æ›¸èªè¨¼
### 1. SSH CAã®æº–å‚™
vaultã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã¨ã—ã¾ã™ã€‚
sshã‚¨ãƒ³ã‚¸ãƒ³ã‚’æœ‰åŠ¹åŒ–ã—ã€ãƒ«ãƒ¼ãƒˆéµãƒšã‚¢ã‚’ä½œæˆã—ã¾ã™ã€‚
```
# sshã‚¨ãƒ³ã‚¸ãƒ³æœ‰åŠ¹åŒ–
vault$ vault secrets enable -path=ssh-client-signer ssh
Success! Enabled the ssh secrets engine at: ssh-client-signer/

# ãƒ«ãƒ¼ãƒˆéµãƒšã‚¢ã‚’ä½œæˆ
vault$ vautl write ssh-client-signer/config/ca generate_signing_key=true
Key           Value
---           -----
public_key    ssh-rsa XXXXXXX
```
### 2. SSHã‚µãƒ¼ãƒã®æº–å‚™
vaultã‹ã‚‰å…¬é–‹éµã‚’å…¥æ‰‹ã—ã¦ä»»æ„ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸ä¿å­˜ã—ã¾ã™ã€‚(ä»Šå›ã¯/etc/sshã®ä¸‹)
```
vault$ curl -o /etc/ssh/trusted-user-ca-keys.pem https://<<FQDN>>:<<port>>/v1/ssh-client-signer/public_key
```
sshd_configã¸ä¿¡é ¼ã™ã‚‹å…¬é–‹éµã¨ã—ã¦è¨­å®šã—ã¾ã™ã€‚(è¨­å®šå¾Œã¯sshdã®å†èµ·å‹•ã‚’å¿˜ã‚Œãšã«ã€‚)
```
vault$ vi /etc/ssh/sshd_config
TrustedUserCAKeys /etc/ssh/trusted-user-ca-keys.pem

vault$ systemctl restart sshd
```
1,2ã¯ä¸€åº¦è¨­å®šã™ã‚Œã°å†åº¦è¨­å®šã™ã‚‹ã“ã¨ã¯åŸºæœ¬çš„ã«ãªã„ã€‚

### 3. roleã®ä½œæˆ
vaultã®sshã‚¨ãƒ³ã‚¸ãƒ³ã«roleã‚’ä½œæˆã™ã‚‹ã€‚
roleã«ã¯æš—å·ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚„èªå¯æƒ…å ±ã‚’è¨­å®šã—ã¾ã™ã€‚
roleã¯ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ã‚„ã€ãƒ­ã‚°ã‚¤ãƒ³å…ˆã‚µãƒ¼ãƒç­‰ã«ã‚ˆã‚Šè¤‡æ•°ä½œæˆã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚(é‹ç”¨æ¬¡ç¬¬)
```
vault$ vault write ssh-client-signer/roles/test-role -<<"EOH"
{
  "algorithm_signer": "rsa-sha2-256",
  "allow_user_certificates": true,
  "allowed_users": "*",
  "allowed_extensions": "permit-pty,permit-port-forwarding",
  "default_extensions": {
    "permit-pty": ""
  },
  "key_type": "ca",
  "default_user": "root",
  "ttl": "30m0s"
}
EOH
```
### 4. SSHã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆéµãƒšã‚¢ã®ä½œæˆã¨å…¬é–‹éµã®ç½²å
```
# éµãƒšã‚¢ä½œæˆ
ssh-client$ ssh-keygen -t rsa
Generating public/private rsa key pair.
Enter file in which to save the key (/root/.ssh/id_rsa):
Created directory '/root/.ssh'.
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in /root/.ssh/id_rsa
Your public key has been saved in /root/.ssh/id_rsa.pub
The key fingerprint is:
~~~~~~~
The key's randomart image is:
+---[RSA 3072]----+
|           .+=   |
|           =..=  |
|        o o +  o |
|       o o o  E o|
|        S + .* B |
|         . +BoO.o|
|          o.=O =+|
|           ..+X.=|
|            .++*+|
+----[SHA256]-----+

ssh-client$ ls -l
total 8
-rw------- 1 root root 2602 Dec  9 14:47 id_rsa
-rw-r--r-- 1 root root  571 Dec  9 14:47 id_rsa.pub

# å…¬é–‹éµã®ç½²å
## SSHã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ã‚µãƒ¼ãƒã§vaultã«ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã€‚
ssh-client$ vault login
Token (will be hidden):
Success! You are now authenticated. The token information displayed below
is already stored in the token helper. You do NOT need to run "vault login"
again. Future Vault requests will automatically use this token.

## å…¬é–‹éµã‚’ç½²åã™ã‚‹ã€‚
ssh-client$ vault write -field=signed_key ssh-client-signer/sign/test-role \
 public_key=@id_rsa.pub > id_rsa-cert.pub

ssh-client$ ls -l
total 20
-rw------- 1 root root 2602 Dec  9 14:47 id_rsa
-rw-r--r-- 1 root root 2282 Dec  9 15:09 id_rsa-cert.pub  # ã§ããŸ
-rw-r--r-- 1 root root  571 Dec  9 14:47 id_rsa.pub
```
### 5. è¨¼æ˜æ›¸ã‚’ä½¿ã„SSHãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹
```
ssh-client$ ssh -i id_rsa-cert.pub -i id_rsa root@ssh-server
# åˆæ¥ç¶šæ™‚ã¯fingerprintãŒå‡ºåŠ›ã™ã‚‹ã€‚SSHã‚µãƒ¼ãƒè¨¼æ˜æ›¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚Œã°å‡ºãªããªã‚‹ã€‚(åˆ¥é€”èª¬æ˜)
The authenticity of host 'ssh-server' can't be established.
RSA key fingerprint is SHA256:~~~~~.
This key is not known by any other names
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added 'ssh-server' (RSA) to the list of known hosts.

ssh-server$  # ãƒ­ã‚°ã‚¤ãƒ³å‡ºæ¥ãŸã€‚
```
:::message
ç§˜å¯†éµã‚’id_rsa, è¨¼æ˜æ›¸ã‚’id_rsa-cert.pubã¨ã„ã†ãƒãƒ¼ãƒŸãƒ³ã‚°ã«ã—ã¦ã„ã‚‹å ´åˆã€-iã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯çœç•¥ã§ãã‚‹ã€‚
ä»¥ä¸‹ã§ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§id_rsa-cert.pub/id_rsaã‚’ä½¿ã„èªè¨¼ã—ã¦ãã‚Œã‚‹ã€‚
ssh-client$ ssh root@ssh-server
:::

## å‚è€ƒ
Hashicorp webãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
https://developer.hashicorp.com/vault/docs/secrets/ssh/signed-ssh-certificates
